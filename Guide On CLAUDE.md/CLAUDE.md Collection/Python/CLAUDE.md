# 开发指南

本文档包含有关使用此代码库的关键信息。请严格遵循以下指南。

## 核心开发规则

1. 包管理
   - 仅使用 uv，绝不使用 pip
   - 安装: `uv add package`
   - 运行工具: `uv run tool`
   - 升级: `uv add --dev package --upgrade-package package`
   - 禁止: `uv pip install`, `@latest` 语法

2. 代码质量
   - 所有代码都需要类型提示
   - 使用 pyrefly 进行类型检查
     - 运行 `pyrefly init` 开始
     - 每次更改后运行 `pyrefly check` 并修复产生的错误
   - 公共 API 必须有文档字符串
   - 函数必须专注且小巧
   - 严格遵循现有模式
   - 行长度: 最多 88 个字符

3. 测试要求
   - 框架: `uv run pytest`
   - 异步测试: 使用 anyio，而不是 asyncio
   - 覆盖率: 测试边缘情况和错误
   - 新功能需要测试
   - 错误修复需要回归测试

4. 代码风格
    - PEP 8 命名 (函数/变量使用 snake_case)
    - 类名使用 PascalCase
    - 常量使用 UPPER_SNAKE_CASE
    - 使用文档字符串进行文档编写
    - 使用 f-strings 进行格式化

## 开发理念

- **简洁**: 编写简单、直接的代码
- **可读性**: 使代码易于理解
- **性能**: 在不牺牲可读性的前提下考虑性能
- **可维护性**: 编写易于更新的代码
- **可测试性**: 确保代码可测试
- **可重用性**: 创建可重用的组件和函数
- **更少的代码 = 更少的债务**: 最小化代码占用空间

## 编码最佳实践

- **提前返回**: 用于避免嵌套条件
- **描述性名称**: 使用清晰的变量/函数名称 (处理程序前缀为 "handle")
- **常量优于函数**: 尽可能使用常量
- **DRY 代码**: 不要重复自己
- **函数式风格**: 在不冗长的情况下，优先选择函数式、不可变的方法
- **最小化更改**: 仅修改与当前任务相关的代码
- **函数排序**: 在其组件之前定义组合函数
- **TODO 注释**: 使用 "TODO:" 前缀标记现有代码中的问题
- **简洁性**: 优先考虑简洁性和可读性，而不是巧妙的解决方案
- **迭代构建**: 从最小功能开始，并在添加复杂性之前验证其是否有效
- **运行测试**: 经常使用真实的输入测试您的代码并验证输出
- **构建测试环境**: 为难以直接验证的组件创建测试环境
- **函数式代码**: 在提高清晰度的情况下使用函数式和无状态方法
- **清晰的逻辑**: 保持核心逻辑清晰，并将实现细节推到边缘
- **文件组织**: 平衡文件组织与简洁性 - 为项目规模使用适当数量的文件

## 系统架构

- 使用 pydantic 和 langchain
- 这个项目是一个非常简单的聊天机器人。将文件保持在最少



## 拉取请求

- 创建详细的更改消息。重点关注问题的高级描述，以及如何解决。除非能增加清晰度，否则不要深入代码细节。

## Git 工作流程

- 始终使用功能分支；不要直接提交到 `main`
  - 描述性地命名分支: `fix/auth-timeout`, `feat/api-pagination`, `chore/ruff-fixes`
  - 每个分支只保留一个逻辑更改，以简化审查和回滚
- 为所有更改创建拉取请求
  - 尽早打开草稿 PR 以提高可见性；完成后转换为就绪状态
  - 在标记为准备审查之前，确保本地测试通过
  - 使用 PR 触发 CI/CD 并启用异步审查
- 链接问题
  - 在开始之前，引用现有问题或创建一个问题
  - 使用 `Fixes #123` 等提交/PR 消息进行自动链接和关闭
- 提交实践
  - 进行原子提交 (每个提交一个逻辑更改)
  - 优先使用约定式提交风格: `type(scope): short description`
    - 示例: `feat(eval): group OBS logs per test`, `fix(cli): handle missing API key`
  - 仅在合并到 `main` 时进行 squash；在功能分支上保留细粒度历史记录
- 实际工作流程
  1. 创建或引用一个问题
  2. `git checkout -b feat/issue-123-description`
  3. 以小而逻辑的增量提交
  4. `git push` 并尽早打开草稿 PR
  5. 功能完成后且测试通过时转换为就绪 PR
  6. 审查和检查通过后合并

## Python 工具

- 使用 context7 mcp 检查库的详细信息

## 代码格式化

1. Ruff
   - 格式化: `uv run ruff format .`
   - 检查: `uv run ruff check .`
   - 修复: `uv run ruff check . --fix`
   - 关键问题:
     - 行长度 (88 个字符)
     - 导入排序 (I001)
     - 未使用的导入
   - 换行:
     - 字符串: 使用括号
     - 函数调用: 多行，并正确缩进
     - 导入: 分成多行

2. 类型检查
  - 运行 `pyrefly init` 开始
  - 运行 `pyrefly check` 每次更改后并修复产生的错误
   - 要求:
     - 对 Optional 进行显式 None 检查
     - 字符串的类型收窄
     - 如果检查通过，可以忽略版本警告


## 错误解决

1. CI 失败
   - 修复顺序:
     1. 格式化
     2. 类型错误
     3. Linting
   - 类型错误:
     - 获取完整的行上下文
     - 检查 Optional 类型
     - 添加类型收窄
     - 验证函数签名

2. 常见问题
   - 行长度:
     - 用括号断开字符串
     - 多行函数调用
     - 分割导入
   - 类型:
     - 添加 None 检查
     - 收窄字符串类型
     - 匹配现有模式

3. 最佳实践
   - 提交前检查 git 状态
   - 在类型检查前运行格式化程序
   - 保持更改最小化
   - 遵循现有模式
   - 文档化公共 API
   - 彻底测试
